<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="map[name:Austin Barnes]"><meta name=description content="Terraofmr Automation"><meta name=keywords content=",terraform,ansible,automation,azure,windows-server"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://www.cinderblook.com/projects/terraform-azure-serv-deploy/><title>Terraform - Azure-Serv-Deploy :: Cinderblook's Website â€” Hello Friend NG Theme</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://www.cinderblook.com/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css><link rel=apple-touch-icon sizes=180x180 href=https://www.cinderblook.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.cinderblook.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.cinderblook.com/favicon-16x16.png><link rel=manifest href=https://www.cinderblook.com/site.webmanifest><link rel=mask-icon href=https://www.cinderblook.com/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://www.cinderblook.com/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Terraform - Azure-Serv-Deploy"><meta itemprop=description content="Terraofmr Automation"><meta itemprop=datePublished content="2022-02-28T00:00:00+00:00"><meta itemprop=dateModified content="2022-02-28T00:00:00+00:00"><meta itemprop=wordCount content="929"><meta itemprop=image content="https://www.cinderblook.com/"><meta itemprop=keywords content="terraform,ansible,automation,azure,windows-server,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.cinderblook.com/"><meta name=twitter:title content="Terraform - Azure-Serv-Deploy"><meta name=twitter:description content="Terraofmr Automation"><meta property="og:title" content="Terraform - Azure-Serv-Deploy"><meta property="og:description" content="Terraofmr Automation"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cinderblook.com/projects/terraform-azure-serv-deploy/"><meta property="og:image" content="https://www.cinderblook.com/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2022-02-28T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-28T00:00:00+00:00"><meta property="og:see_also" content="https://www.cinderblook.com/projects/terraform-vsphere-winserv-deployment/"><meta property="article:section" content="Projects"><meta property="article:section" content="Terraform"><meta property="article:section" content="Ansible"><meta property="article:section" content="Azure"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2022-02-28 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=https://www.cinderblook.com/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://www.cinderblook.com/about>About</a></li><li><a href=https://www.cinderblook.com/projects>Projects</a></li><li><a href=https://www.cinderblook.com/sites>Sites</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://www.cinderblook.com/projects/terraform-azure-serv-deploy/>Terraform - Azure-Serv-Deploy</a></h2><div class=post-content><h1 id=overview>Overview</h1><p>Deploy and Configure 4 Windows 2022 Datacenter Servers in Azure.</p><ul><li>Using Terraform in conjunction with Ansible: Create 4 Windows Servers<ul><li>Configure them to be a Primary Domain Controller, Replica Domain Controller, DHCP server, and Fileshare server</li><li>Automate intial setup of the 4 servers to accept Ansible configuration from a Linux VM in Azure created VIA the Terraform deployment</li></ul></li></ul><h1 id=terraform>Terraform</h1><p>Main role: Deploy the Virtual Machines, setup Network environment, and provide intial parameters for both Windows and Linux environments running in the cloud</p><ul><li>Setup the four Windows Servers (Primary Domain Controller, Replica Domain Controller, DHCP, Fileshare) in Azure<ul><li>These will all be Windows 2022 Datacenter Servers running on Standard_DS1_V2 by default</li></ul></li><li>Setup the one Linux server to deploy a pre-defined Ansible configuration across the Windows Environment for setting up Active Directory, DHCP, File shares, users, and groups.<ul><li>This will all be an Ubuntu 18.04-LTS server running on Standard_B1s by default</li><li>It will use cloud-init to supply it the necessary setup at creation for Ansible and SSH connection VIA its public IP address.</li></ul></li><li>Supply necessary networking variables (Network interfaces, Security Groups, IP Addressing)</li><li>Supply necessary files for automation of Windows & Linux environments (Cloud-Init & Windows Unattend files)</li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li>Setup necessary Terraform <a href=https://learn.hashicorp.com/tutorials/terraform/install-cli>environment</a></li><li>Install and setup <a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>Azure CLI</a> or preferred method of authentication to Azure</li><li>Configure variables for desired outcomes (Outlined further down)</li></ul><h2 id=terraform-process>Terraform process</h2><ul><li>Using the Azure provider:<ul><li>Login to Azure with <code>az connect</code></li></ul></li><li>Once prepared with appropriate values and the networking is in place:<ul><li>Navigate to the Terraform directory and run these commands</li><li><code>terraform init</code> Pull proper Terraform providers and modules used</li><li><code>terraform validate</code> This will return whether the configuration is valid or not</li><li><code>terraform apply</code> &mldr; <code>yes</code> Actually apply the configuration</li></ul></li></ul><h2 id=terraform-file-structure>Terraform File Structure</h2><h3 id=providertf-file><em>provider.tf</em> File</h3><ul><li>Calls necessary providers and sets their versions to be used in the Terraform configuration/deployment</li></ul><h3 id=networkingtf-file><em>networking.tf</em> File</h3><ul><li>Defines resources, security groups, security rules, network interfaces, subnets, and public IPs to be created in Azure.<ul><li>These variables are pulled from the VM creation resources</li><li>Managed with variables contained in terraform.tfvars file</li></ul></li></ul><h3 id=variablestf-terraformtfvars-files><em>variables.tf, terraform.tfvars</em> Files</h3><ul><li>Alter variables within these files to ensure they meet your environment needs<ul><li><em>variables.tf</em><ul><li>Declare variables that will be used with the Terraform configuration (Delcared intially or explicitely here as <code>locals</code> variables)<ul><li><em>firsT_logon_commands</em> local variable points to a .xml file to configure first time logon in Windows. This enables each server to recieve Winrm data on port 5985 for Ansible configuration</li><li>*auto_logon_ runs a .xml configuration to log in once right after intial creation of VM. This allows <em>first_logon_commands</em> to execute automatically</li></ul></li></ul></li><li><em>terraform.tfvars</em><ul><li>Assign variables values here. These will be used with the Terraform configuration. If left blank, you can assign the variable at the terminal level when running the <code>terraform apply</code><ul><li>Alter Network values to desired IP addressing scheme<ul><li><strong>Ensure IP addressing matches that in the Ansible configuration inventory.yml</strong></li></ul></li><li>Here you can alter azure values for <em>publisher</em>, <em>offer</em>, <em>sku</em>, <em>size</em>, <em>sa</em>, and <em>license</em> information for the Windows/Linux VMs</li><li>Additionally, ensure <code>linux_ssh_key</code> point to your public Key <code>id_rsa.pubc</code> file</li><li>I recommend to change <em>winadmin_username</em> & <em>winadmin_password</em> variables to sensetive and blank so you can delcare them in preferrably Vaulty or via the CLI<ul><li><strong><em>winadmin_username</em> & <em>winadmin_password</em> MUST MATCH WHAT IS IN ANSIBLE /group_vars/all.yml</strong></li></ul></li></ul></li></ul></li></ul></li></ul><h3 id=01-linuxclienttf--02-winserverstf-files><em>01-LinuxClient.tf</em> & <em>02-WinServers.tf</em> Files</h3><ul><li>Here the creation of the VMs occur. Resources pull data from <em>networking.tf</em>, <em>variables.tf</em>, <em>terraform.tfvars</em> files.<ul><li>Windows VMs are assigned unattend configurations for first time setup (/winfiles/FirstLogonCommands.xml && <em>auto_logon</em> variable data)</li><li>Linux Machine is assigned a cloud-init file configuraiton for first time setup (/cloudinit/custom.yml)</li></ul></li></ul><h3 id=outputstf-file><em>outputs.tf</em> File</h3><ul><li>Provides necessary ip information that is allocated to the VMs created.</li><li>This information by default includes:<ul><li>Private IPs for all 5 deployed VMs (Which we know will by based on variables.tf file data)</li><li>Public IP for Linux machine (Not known by default, will be used for SSH connection if needed).</li></ul></li></ul><h2 id=useful-azure-related-functions>Useful Azure related functions</h2><p>Finding variable information for VM Images variables:</p><ul><li>You can use this command in Azure CLI to find UbuntuServer data. Change the values in offer, publisher, location, and sku for various other images.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Powershell data-lang=Powershell><span style=display:flex><span>   az vm image list \
</span></span><span style=display:flex><span>   --location westus \
</span></span><span style=display:flex><span>   --publisher Canonical \  
</span></span><span style=display:flex><span>   --offer UbuntuServer \    
</span></span><span style=display:flex><span>   --sku 18.04-LTS \
</span></span><span style=display:flex><span>   --all --output table
</span></span></code></pre></div><ul><li>&ldquo;Check out Microsoft&rsquo;s&rdquo; <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/cli-ps-findimage>documentation</a> on finding VM information</li></ul><h1 id=ansible>Ansible</h1><p>Main role: Configure the deployed Virtual Machines.</p><ul><li>Setup Windows Server Feature: Domain<ul><li>Primary Domain Controller</li><li>Replica Domain Controller</li><li>Auto-Join the Virutal Machines to the respective Domain created</li><li>Create a few users and groups within Active Directory</li></ul></li><li>Setup Windows Ssrver Feature: DHCP<ul><li>Setup DHCP Scope</li><li>Authorize it to the Domain.</li></ul></li><li>Setup Windows Server Feature: File Sharing<ul><li>Create two shares<ul><li>An employee share and administrator share. These shares are assigned group permissions.</li></ul></li></ul></li><li>Common Configurations<ul><li>Enable RDP and allow it through the firewall on all windows servers created at server level</li></ul></li></ul><h2 id=ansible-variable-files>Ansible Variable files</h2><ul><li><em>inventory.yml</em><ul><li>Modify hosts associated with the playbook. Assign the IP addressing<ul><li><strong>MUST MATCH <em>terraform.tfvars</em> VARIABLE IP ADDRESSING</strong></li></ul></li></ul></li><li><em>winlab.yml</em><ul><li>Associate &lsquo;roles&rsquo; to the hosts identified in the inventory file.</li><li>These &lsquo;roles&rsquo; are folders within the directory containing a set of code to configure per host</li></ul></li><li><em>ansible.cfg</em><ul><li>Tells ansible variable information. In this scenario, identifies to use inventory.yml file.</li></ul></li><li><em>./group_vars/all.yml</em><ul><li>Contains specific variable information used within the ./roles/* Ansible code.</li><li>Alter user, password, port, connection, and cert variable information</li><li>Alter domain variables as well</li></ul></li></ul><h2 id=running-ansible>Running Ansible</h2><p>This is taken care of with terraform cloud-init file along with the file provisioner. The alternative would be below.</p><ul><li>On Linux Machine,<ul><li>Requires: Python-pip, ansible-galaxzy-azure.azure_preview_modules</li><li>To Run: Navigate to Ansible directory and type <code>ansible-playbook winlab.yml</code></li></ul></li></ul><h1 id=useful-resources>Useful Resources</h1><h2 id=terraform-resources>Terraform Resources</h2><ul><li>Terraform <a href=https://www.terraform.io/docs>Documentation</a></li><li>Azure <a href=https://registry.terraform.io/providers/hashicorp/azurerm/2.96.0>Provider</a> & <a href=https://registry.terraform.io/modules/Azure/compute/azurerm/latest>Modules</a></li><li>Cloud-init <a href=https://cloudinit.readthedocs.io/en/latest/>Documentation</a></li><li><a href=https://github.com/hashicorp/terraform-provider-azurerm>terraform-provider-azurerm</a> examples and documentation on GitHub</li></ul><h2 id=ansible-resources>Ansible Resources</h2><ul><li>Ansible <a href=https://docs.ansible.com/>Documentation</a><ul><li><a href="https://galaxy.ansible.com/ansible/windows?extIdCarryOver=true&sc_cid=701f2000001OH7YAAW">Windows-Modules</a></li></ul></li></ul></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://www.cinderblook.com/tags/terraform/>terraform</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/ansible/>ansible</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/automation/>automation</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/azure/>azure</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/windows-server/>windows-server</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://www.cinderblook.com/categories/projects/>Projects</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/terraform/>Terraform</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/ansible/>Ansible</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/azure/>Azure</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/linux/>Linux</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2022</span>
<span><a href=https://www.cinderblook.com/>Austin Barnes</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://www.cinderblook.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span></div></div></footer></div><script type=text/javascript src=https://www.cinderblook.com/bundle.min.2d3d449fc0ff117f00ac91342a8f76cd5b710411d7a0254dbe75da3234d2f685d6a0c44cff60c414e90b6a149da8e4032c713c25e4e6838e2e3918dc0ad2e81c.js integrity="sha512-LT1En8D/EX8ArJE0Ko92zVtxBBHXoCVNvnXaMjTS9oXWoMRM/2DEFOkLahSdqOQDLHE8JeTmg44uORjcCtLoHA=="></script></body></html>
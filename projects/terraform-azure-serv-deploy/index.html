<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="map[name:Austin Barnes]"><meta name=description content="Terraofmr Automation"><meta name=keywords content=",terraform,ansible,automation,azure,windows-server"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://www.cinderblook.com/projects/terraform-azure-serv-deploy/><title>Terraform - Azure-Serv-Deploy :: Cinderblook's Website â€” Hello Friend NG Theme</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://www.cinderblook.com/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css><link rel=apple-touch-icon sizes=180x180 href=https://www.cinderblook.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.cinderblook.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.cinderblook.com/favicon-16x16.png><link rel=manifest href=https://www.cinderblook.com/site.webmanifest><link rel=mask-icon href=https://www.cinderblook.com/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://www.cinderblook.com/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Terraform - Azure-Serv-Deploy"><meta itemprop=description content="Terraofmr Automation"><meta itemprop=datePublished content="2022-02-28T00:00:00+00:00"><meta itemprop=dateModified content="2022-02-28T00:00:00+00:00"><meta itemprop=wordCount content="2276"><meta itemprop=image content="https://www.cinderblook.com/"><meta itemprop=keywords content="terraform,ansible,automation,azure,windows-server,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.cinderblook.com/"><meta name=twitter:title content="Terraform - Azure-Serv-Deploy"><meta name=twitter:description content="Terraofmr Automation"><meta property="og:title" content="Terraform - Azure-Serv-Deploy"><meta property="og:description" content="Terraofmr Automation"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cinderblook.com/projects/terraform-azure-serv-deploy/"><meta property="og:image" content="https://www.cinderblook.com/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2022-02-28T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-28T00:00:00+00:00"><meta property="og:see_also" content="https://www.cinderblook.com/projects/terraform-vsphere-winserv-deployment/"><meta property="article:section" content="Projects"><meta property="article:section" content="Terraform"><meta property="article:section" content="Ansible"><meta property="article:section" content="Azure"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2022-02-28 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=https://www.cinderblook.com/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://www.cinderblook.com/about>About</a></li><li><a href=https://www.cinderblook.com/projects>Projects</a></li><li><a href=https://www.cinderblook.com/sites>Sites</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://www.cinderblook.com/projects/terraform-azure-serv-deploy/>Terraform - Azure-Serv-Deploy</a></h2><div class=post-content><h1 id=overview>Overview</h1><p>Deploy and Configure 4 Windows 2022 Datacenter Servers in Azure.</p><ul><li>Using Terraform in conjunction with Ansible: Create 4 Windows Servers<ul><li>Configure them to be a Primary Domain Controller, Replica Domain Controller, DHCP server, and Fileshare server</li><li>Automate intial setup of the 4 servers to accept Ansible configuration from a Linux VM in Azure created VIA the Terraform deployment</li></ul></li></ul><h1 id=terraform>Terraform</h1><p>Main role: Deploy the Virtual Machines, setup Network environment, and provide intial parameters for both Windows and Linux environments running in the cloud</p><ul><li>Setup the four Windows Servers (Primary Domain Controller, Replica Domain Controller, DHCP, Fileshare) in Azure<ul><li>These will all be Windows 2022 Datacenter Servers running on Standard_DS1_V2 by default</li></ul></li><li>Setup the one Linux server to deploy a pre-defined Ansible configuration across the Windows Environment for setting up Active Directory, DHCP, File shares, users, and groups.<ul><li>This will all be an Ubuntu 18.04-LTS server running on Standard_B1s by default</li><li>It will use cloud-init to supply it the necessary setup at creation for Ansible and SSH connection VIA its public IP address.</li></ul></li><li>Supply necessary networking variables (Network interfaces, Security Groups, IP Addressing)</li><li>Supply necessary files for automation of Windows & Linux environments (Cloud-Init & Windows Unattend files)</li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li>Setup necessary Terraform <a href=https://learn.hashicorp.com/tutorials/terraform/install-cli>environment</a></li><li>Install and setup <a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>Azure CLI</a> or preferred method of authentication to Azure</li><li>Configure variables for desired outcomes (Outlined further down)</li></ul><h2 id=terraform-process>Terraform process</h2><ul><li>Using the Azure provider:<ul><li>Login to Azure with <code>az connect</code></li></ul></li><li>Once prepared with appropriate values and the networking is in place:<ul><li>Navigate to the Terraform directory and run these commands</li><li><code>terraform init</code> Pull proper Terraform providers and modules used</li><li><code>terraform validate</code> This will return whether the configuration is valid or not</li><li><code>terraform apply</code> &mldr; <code>yes</code> Actually apply the configuration</li></ul></li></ul><h2 id=terraform-file-structure>Terraform File Structure</h2><p>Create a new directory, and place the following files in it, with your own variables</p><h3 id=providertf-file><em>provider.tf</em> File</h3><ul><li>Calls necessary providers and sets their versions to be used in the Terraform configuration/deployment. Informs Terraform which modules and providers to use.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>azurerm</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span>  = <span style=color:#e6db74>&#34;hashicorp/azurerm&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;&gt;=2.91.0&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>features</span> {}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=networkingtf-file><em>networking.tf</em> File</h3><ul><li>Defines resources, security groups, security rules, network interfaces, subnets, and public IPs to be created in Azure.<ul><li>These variables are pulled from the VM creation resources</li><li>Managed with variables contained in terraform.tfvars file</li></ul></li></ul><p>networking.tf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># Create a resource group to maintain security settings along with network interfaces for VMs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;east&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terra-resources&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;East US&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># ASSIGN ADDRESS SPACE TO RESOURCE GROUP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_virtual_network&#34; &#34;east&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;east-network&#34;</span>
</span></span><span style=display:flex><span>  address_space       <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;${var.east_address_spaces}&#34;</span>]
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># ASSIGN SUBNET TO NETWORK ADDRESS SPACE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_subnet&#34; &#34;subnet1&#34;</span> {
</span></span><span style=display:flex><span>  name                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name  <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  virtual_network_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_virtual_network</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  address_prefixes     <span style=color:#f92672>=</span> [<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>east_subnets</span>]
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Create public IP variable for Linux machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_public_ip&#34; &#34;linux_public&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PublicIp1&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  allocation_method   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># Create public IP variable for Windows machine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_public_ip&#34; &#34;win_public&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PublicIp2&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  allocation_method   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># ASSIGN NETWORK INTERFACE PER VM WE WILL BE USING
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34; &#34;linux1&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;linux1-nic&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ip_configuration</span> {
</span></span><span style=display:flex><span>    name                          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>    subnet_id                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_subnet</span>.<span style=color:#66d9ef>subnet1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    private_ip_address_allocation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>    private_ip_address            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>linux1_priavte_ip</span>    
</span></span><span style=display:flex><span>    public_ip_address_id          <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_public_ip</span>.<span style=color:#66d9ef>linux_public</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34; &#34;winserv1&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;winserv1-nic&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ip_configuration</span> {
</span></span><span style=display:flex><span>    name                          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>    subnet_id                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_subnet</span>.<span style=color:#66d9ef>subnet1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    private_ip_address_allocation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>    private_ip_address            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>winserv1_private_ip</span>
</span></span><span style=display:flex><span>    public_ip_address_id          <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_public_ip</span>.<span style=color:#66d9ef>win_public</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34; &#34;winserv2&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;winserv2-nic&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ip_configuration</span> {
</span></span><span style=display:flex><span>    name                          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>    subnet_id                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_subnet</span>.<span style=color:#66d9ef>subnet1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    private_ip_address_allocation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>    private_ip_address            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>winserv2_private_ip</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34; &#34;winserv3&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;winserv3-nic&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ip_configuration</span> {
</span></span><span style=display:flex><span>    name                          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>    subnet_id                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_subnet</span>.<span style=color:#66d9ef>subnet1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    private_ip_address_allocation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>    private_ip_address            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>winserv3_private_ip</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface&#34; &#34;winserv4&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;winserv4-nic&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ip_configuration</span> {
</span></span><span style=display:flex><span>    name                          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;internal&#34;</span>
</span></span><span style=display:flex><span>    subnet_id                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_subnet</span>.<span style=color:#66d9ef>subnet1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    private_ip_address_allocation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Static&#34;</span>
</span></span><span style=display:flex><span>    private_ip_address            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>winserv4_private_ip</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># CREATE SECURITY GROUPs TO ALLOW SSH/RDP/ANSIBLE FOR VMs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_security_group&#34; &#34;linux1&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow-SSH&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>security_rule</span> {
</span></span><span style=display:flex><span>    name                       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SSH&#34;</span>
</span></span><span style=display:flex><span>    priority                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    direction                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Inbound&#34;</span>
</span></span><span style=display:flex><span>    access                     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>    protocol                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tcp&#34;</span>
</span></span><span style=display:flex><span>    source_port_range          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_port_range     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;22&#34;</span>
</span></span><span style=display:flex><span>    source_address_prefix      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_address_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_security_group&#34; &#34;winserv&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow-RDP-SSH-ANS&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>east</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>security_rule</span> {
</span></span><span style=display:flex><span>    name                       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RDP&#34;</span>
</span></span><span style=display:flex><span>    priority                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>101</span>
</span></span><span style=display:flex><span>    direction                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Inbound&#34;</span>
</span></span><span style=display:flex><span>    access                     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>    protocol                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tcp&#34;</span>
</span></span><span style=display:flex><span>    source_port_range          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_port_range     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3389&#34;</span>
</span></span><span style=display:flex><span>    source_address_prefix      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_address_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>security_rule</span> {
</span></span><span style=display:flex><span>    name                       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SSH&#34;</span>
</span></span><span style=display:flex><span>    priority                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>102</span>
</span></span><span style=display:flex><span>    direction                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Inbound&#34;</span>
</span></span><span style=display:flex><span>    access                     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>    protocol                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tcp&#34;</span>
</span></span><span style=display:flex><span>    source_port_range          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_port_range     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;22&#34;</span>
</span></span><span style=display:flex><span>    source_address_prefix      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_address_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>security_rule</span> {
</span></span><span style=display:flex><span>    name                       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ANSIBLE&#34;</span>
</span></span><span style=display:flex><span>    priority                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>103</span>
</span></span><span style=display:flex><span>    direction                  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Inbound&#34;</span>
</span></span><span style=display:flex><span>    access                     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>    protocol                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tcp&#34;</span>
</span></span><span style=display:flex><span>    source_port_range          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    destination_port_range     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5985&#34;</span>
</span></span><span style=display:flex><span>    source_address_prefix      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.east_subnets}&#34;</span>
</span></span><span style=display:flex><span>    destination_address_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># ASSIGN SECURITY GROUPS TO INTERFACES
</span></span></span><span style=display:flex><span><span style=color:#75715e># LINUX SSH
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34; &#34;linux1&#34;</span> {
</span></span><span style=display:flex><span>  network_interface_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_interface</span>.<span style=color:#66d9ef>linux1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  network_security_group_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_security_group</span>.<span style=color:#66d9ef>linux1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># WINSERV RDP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34; &#34;winserv1&#34;</span> {
</span></span><span style=display:flex><span>  network_interface_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_interface</span>.<span style=color:#66d9ef>winserv1</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  network_security_group_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_security_group</span>.<span style=color:#66d9ef>winserv</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34; &#34;winserv2&#34;</span> {
</span></span><span style=display:flex><span>  network_interface_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_interface</span>.<span style=color:#66d9ef>winserv2</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  network_security_group_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_security_group</span>.<span style=color:#66d9ef>winserv</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34; &#34;winserv3&#34;</span> {
</span></span><span style=display:flex><span>  network_interface_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_interface</span>.<span style=color:#66d9ef>winserv3</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  network_security_group_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_security_group</span>.<span style=color:#66d9ef>winserv</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_network_interface_security_group_association&#34; &#34;winserv4&#34;</span> {
</span></span><span style=display:flex><span>  network_interface_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_interface</span>.<span style=color:#66d9ef>winserv4</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  network_security_group_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_network_security_group</span>.<span style=color:#66d9ef>winserv</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=variablestf-terraformtfvars-files><em>variables.tf, terraform.tfvars</em> Files</h3><ul><li>Alter variables within these files to ensure they meet your environment needs<ul><li><em>variables.tf</em><ul><li>Declare variables that will be used with the Terraform configuration (Delcared intially or explicitely here as <code>locals</code> variables)</li><li>Specific local variables used for Windows .xml files<ul><li><em>firsT_logon_commands</em> local variable points to a .xml file to configure first time logon in Windows. This enables each server to recieve Winrm data on port 5985 for Ansible configuration</li><li>*auto_logon_ runs a .xml configuration to log in once right after intial creation of VM. This allows <em>first_logon_commands</em> to execute automatically</li></ul></li></ul></li></ul></li></ul><div class="hugo-collapse-parent
closed" data-text-closed="See More â–¼" data-text-open="See Less â–²"><link rel=stylesheet href=https://www.cinderblook.com//css/collapse.css><script type=text/javascript src=https://www.cinderblook.com///js/collapse.js></script><div class="collapseAfter hugo-collapse-above"><p>variables.tf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_vm_os_publisher&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_vm_os_offer&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_vm_os_sku&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_vm_size&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winadmin_username&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winadmin_password&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_license&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_sa_type&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_pdc&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_rdc&#34;</span> {} 
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_dhcp&#34;</span> {} 
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_file&#34;</span> {}    
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_server&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_vm_os_publisher&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_vm_os_offer&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_vm_os_sku&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_vm_size&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_ssh_key&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_sa_type&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux_ssh_key_pv&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_allocation_method&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;east_address_spaces&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;east_subnets&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv_public_ip_sku&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv1_private_ip&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv2_private_ip&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv3_private_ip&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;winserv4_private_ip&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linux1_priavte_ip&#34;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>locals</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>first_logon_commands</span>        = file(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>path</span>.module<span style=color:#e6db74>}</span><span style=color:#e6db74>/          winfiles/FirstLogonCommands.xml&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>auto_logon</span>                  =           <span style=color:#e6db74>&#34;&lt;AutoLogon&gt;&lt;Password&gt;&lt;Value&gt;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>winadmin_password</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/          Value&gt;&lt;/Password&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;LogonCount&gt;1&lt;/          LogonCount&gt;&lt;Username&gt;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>winadmin_username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/          Username&gt;&lt;/AutoLogon&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div>- *terraform.tfvars*
- Assign variables values here. These will be used with the Terraform configuration. If left blank, you can assign the variable at the terminal level when running the `terraform apply`
- Alter Network values to desired IP addressing scheme
- **Ensure IP addressing matches that in the Ansible configuration inventory.yml**
- Here you can alter azure values for _publisher_, _offer_, _sku_, _size_, _sa_, and _license_ information for the Windows/Linux VMs
- Additionally, ensure `linux_ssh_key` point to your public Key `id_rsa.pubc` file
- I recommend to change _winadmin_username_ & _winadmin_password_ variables to sensetive and blank so you can delcare them in preferrably Vaulty or via the CLI
- **_winadmin_username_ & _winadmin_password_ MUST MATCH WHAT IS IN ANSIBLE /group_vars/all.yml**
- ```tf
# Azure Windows Server related params
winserv_vm_os_publisher = "MicrosoftWindowsServer"
winserv_vm_os_offer = "WindowsServer"
winserv_vm_os_sku = "2022-Datacenter"
winserv_vm_size = "Standard_DS1_V2"
winserv_license = "Windows_Server"
winserv_allocation_method = "Static"
winserv_public_ip_sku = "Standard"
winserv_sa_type = "Standard_LRS"
# Azure Linux Server related params
linux_vm_os_publisher = "Canonical"
linux_vm_os_offer = "UbuntuServer"
linux_vm_os_sku = "18.04-LTS"
linux_vm_size = "Standard_B1s"
linux_ssh_key = "Local-PUBLIC-SSH-KEY-Here"
linux_sa_type = "Premium_LRS"
linux_ssh_key_pv = "Local-PRIV-SSH-KEY-Here"
# Which Windows administrator password to set during vm customization
winadmin_username = "SuperAdministrator"
winadmin_password = "Password1234"
# Naming Schemes
winserv_pdc = "ajb-pdc"
winserv_rdc = "ajb-rdc"
winserv_dhcp = "ajb-dhcp"
winserv_file = "ajb-file"
linux_server = "ajb-operator"
# Networking Variables
winserv1_private_ip = "10.0.1.10"
winserv2_private_ip = "10.0.1.11"
winserv3_private_ip = "10.0.1.12"
winserv4_private_ip = "10.0.1.13"
linux1_priavte_ip = "10.0.1.9"
east_address_spaces = "10.0.0.0/16"
east_subnets = "10.0.1.0/24"
```
### *01-LinuxClient.tf* & *02-WinServers.tf* Files
- Here the creation of the VMs occur. Resources pull data from _networking.tf_, _variables.tf_, _terraform.tfvars_ files.
- Windows VMs are assigned unattend configurations for first time setup (/winfiles/FirstLogonCommands.xml && _auto_logon_ variable data)
    - Linux Machine is assigned a cloud-init file configuraiton for first time setup (/cloudinit/custom.yml) We will create this in the next step.
01-LinuxClient.tf
```tf
# This pulls a Ubuntu Datacenter from Microsoft's VM platform directly
resource "azurerm_linux_virtual_machine" "operator" {
name = var.linux_server
resource_group_name = azurerm_resource_group.east.name
location = azurerm_resource_group.east.location
size = var.linux_vm_size
admin_username = var.winadmin_username
network_interface_ids = [
azurerm_network_interface.linux1.id
]
admin_ssh_key {
username = var.winadmin_username
public_key = file("${var.linux_ssh_key}")
}
# Cloud-Init passed here
custom_data = data.template_cloudinit_config.config.rendered
os_disk {
caching = "ReadWrite"
storage_account_type = var.linux_sa_type
}
source_image_reference {
publisher = var.linux_vm_os_publisher
offer = var.linux_vm_os_offer
sku = var.linux_vm_os_sku
version = "latest"
}
depends_on = [azurerm_resource_group.east, azurerm_network_interface.linux1]
}
# Create cloud-init file to be passed into linux vm
data "template_file" "user_data" {
template = file("./cloudinit/custom.yml")
}
# Render a multi-part cloud-init config making use of the part
# above, and other source files
data "template_cloudinit_config" "config" {
gzip = true
base64_encode = true
# Main cloud-config configuration file.
part {
filename = "init.cfg"
content_type = "text/cloud-config"
content = "${data.template_file.user_data.rendered}"
}
}
# Pass Ansible File into created Linux VM using SCP (SSH Port 22)
resource "null_resource" "copyansible"{
connection {
type = "ssh"
host = azurerm_public_ip.linux_public.ip_address
user = var.winadmin_username
private_key = file("${var.linux_ssh_key_pv}")
}
provisioner "file" {
source = "${path.module}/Ansible"
destination = "/tmp/"
}
depends_on = [azurerm_linux_virtual_machine.operator]
}
```
02-WinServers.tf
```tf
# This pulls the latest Windows Server Datacenter from Microsoft's VM platform directly
resource "azurerm_windows_virtual_machine" "pdc" {
name = var.winserv_pdc
resource_group_name = azurerm_resource_group.east.name
location = azurerm_resource_group.east.location
size = var.winserv_vm_size
admin_username = var.winadmin_username
admin_password = var.winadmin_password
network_interface_ids = [
azurerm_network_interface.winserv1.id
]
os_disk {
caching = "ReadWrite"
storage_account_type = var.winserv_sa_type
}
source_image_reference {
publisher = var.winserv_vm_os_publisher
offer = var.winserv_vm_os_offer
sku = var.winserv_vm_os_sku
version = "latest"
}
additional_unattend_content {
content = local.auto_logon
setting = "AutoLogon"
}
additional_unattend_content {
content = local.first_logon_commands
setting = "FirstLogonCommands"
}
depends_on = [azurerm_resource_group.east, azurerm_network_interface.winserv1]
}
resource "azurerm_windows_virtual_machine" "rdc" {
name = var.winserv_rdc
resource_group_name = azurerm_resource_group.east.name
location = azurerm_resource_group.east.location
size = var.winserv_vm_size
admin_username = var.winadmin_username
admin_password = var.winadmin_password
network_interface_ids = [
azurerm_network_interface.winserv2.id
]
os_disk {
caching = "ReadWrite"
storage_account_type = var.winserv_sa_type
}
source_image_reference {
publisher = var.winserv_vm_os_publisher
offer = var.winserv_vm_os_offer
sku = var.winserv_vm_os_sku
version = "latest"
}
additional_unattend_content {
content = local.auto_logon
setting = "AutoLogon"
}
additional_unattend_content {
content = local.first_logon_commands
setting = "FirstLogonCommands"
}
depends_on = [azurerm_resource_group.east, azurerm_network_interface.winserv2]
}
resource "azurerm_windows_virtual_machine" "dhcp" {
name = var.winserv_dhcp
resource_group_name = azurerm_resource_group.east.name
location = azurerm_resource_group.east.location
size = var.winserv_vm_size
admin_username = var.winadmin_username
admin_password = var.winadmin_password
network_interface_ids = [
azurerm_network_interface.winserv3.id
]
os_disk {
caching = "ReadWrite"
storage_account_type = var.winserv_sa_type
}
source_image_reference {
publisher = var.winserv_vm_os_publisher
offer = var.winserv_vm_os_offer
sku = var.winserv_vm_os_sku
version = "latest"
}
additional_unattend_content {
content = local.auto_logon
setting = "AutoLogon"
}
additional_unattend_content {
content = local.first_logon_commands
setting = "FirstLogonCommands"
}
depends_on = [azurerm_resource_group.east, azurerm_network_interface.winserv3]
}
resource "azurerm_windows_virtual_machine" "file" {
name = var.winserv_file
resource_group_name = azurerm_resource_group.east.name
location = azurerm_resource_group.east.location
size = var.winserv_vm_size
admin_username = var.winadmin_username
admin_password = var.winadmin_password
network_interface_ids = [
azurerm_network_interface.winserv4.id
]
os_disk {
caching = "ReadWrite"
storage_account_type = var.winserv_sa_type
}
source_image_reference {
publisher = var.winserv_vm_os_publisher
offer = var.winserv_vm_os_offer
sku = var.winserv_vm_os_sku
version = "latest"
}
additional_unattend_content {
content = local.auto_logon
setting = "AutoLogon"
}
additional_unattend_content {
content = local.first_logon_commands
setting = "FirstLogonCommands"
}
depends_on = [azurerm_resource_group.east, azurerm_network_interface.winserv4]
}
```
### *outputs.tf* File
- Provides necessary ip information that is allocated to the VMs created.
- This information by default includes:
- Private IPs for all 5 deployed VMs (Which we know will by based on variables.tf file data)
- Public IP for Linux machine (Not known by default, will be used for SSH connection if needed).
## Useful Azure related functions
Finding variable information for VM Images variables:
- You can use this command in Azure CLI to find UbuntuServer data. Change the values in offer, publisher, location, and sku for various other images.
````Powershell
az vm image list \
--location westus \
--publisher Canonical \
--offer UbuntuServer \
--sku 18.04-LTS \
--all --output table
````
- "Check out Microsoft's" [documentation](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/cli-ps-findimage) on finding VM information
# Ansible
Main role: Configure the deployed Virtual Machines.
- Setup Windows Server Feature: Domain
- Primary Domain Controller
- Replica Domain Controller
- Auto-Join the Virutal Machines to the respective Domain created
- Create a few users and groups within Active Directory
- Setup Windows Ssrver Feature: DHCP
- Setup DHCP Scope
- Authorize it to the Domain.
- Setup Windows Server Feature: File Sharing
- Create two shares
- An employee share and administrator share. These shares are assigned group permissions.
- Common Configurations
- Enable RDP and allow it through the firewall on all windows servers created at server level
## Ansible Variable files
- *inventory.yml*
- Modify hosts associated with the playbook. Assign the IP addressing
- **MUST MATCH _terraform.tfvars_ VARIABLE IP ADDRESSING**
- *winlab.yml*
- Associate 'roles' to the hosts identified in the inventory file.
- These 'roles' are folders within the directory containing a set of code to configure per host
- *ansible.cfg*
- Tells ansible variable information. In this scenario, identifies to use inventory.yml file.
- *./group_vars/all.yml*
- Contains specific variable information used within the ./roles/* Ansible code.
- Alter user, password, port, connection, and cert variable information
- Alter domain variables as well
## Running Ansible
This is taken care of with terraform cloud-init file along with the file provisioner. The alternative would be below.
- On Linux Machine,
- Requires: Python-pip, ansible-galaxzy-azure.azure_preview_modules
- To Run: Navigate to Ansible directory and type `ansible-playbook winlab.yml`
# Useful Resources
## Terraform Resources
- Terraform [Documentation](https://www.terraform.io/docs)
- Azure [Provider](https://registry.terraform.io/providers/hashicorp/azurerm/2.96.0) & [Modules](https://registry.terraform.io/modules/Azure/compute/azurerm/latest)
- Cloud-init [Documentation](https://cloudinit.readthedocs.io/en/latest/)
- [terraform-provider-azurerm](https://github.com/hashicorp/terraform-provider-azurerm) examples and documentation on GitHub
## Ansible Resources
- Ansible [Documentation](https://docs.ansible.com/)
- [Windows-Modules](https://galaxy.ansible.com/ansible/windows?extIdCarryOver=true&sc_cid=701f2000001OH7YAAW)

</div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://www.cinderblook.com/tags/terraform/>terraform</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/ansible/>ansible</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/automation/>automation</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/azure/>azure</a></span>
<span class=tag><a href=https://www.cinderblook.com/tags/windows-server/>windows-server</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=https://www.cinderblook.com/categories/projects/>Projects</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/terraform/>Terraform</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/ansible/>Ansible</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/azure/>Azure</a></span>
<span class=tag><a href=https://www.cinderblook.com/categories/linux/>Linux</a></span></p></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2022</span>
<span><a href=https://www.cinderblook.com/>Austin Barnes</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://www.cinderblook.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span></div></div></footer></div><script type=text/javascript src=https://www.cinderblook.com/bundle.min.2d3d449fc0ff117f00ac91342a8f76cd5b710411d7a0254dbe75da3234d2f685d6a0c44cff60c414e90b6a149da8e4032c713c25e4e6838e2e3918dc0ad2e81c.js integrity="sha512-LT1En8D/EX8ArJE0Ko92zVtxBBHXoCVNvnXaMjTS9oXWoMRM/2DEFOkLahSdqOQDLHE8JeTmg44uORjcCtLoHA=="></script></body></html>
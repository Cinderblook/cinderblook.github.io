<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="/favicon.svg">

  <title>
    Terraform - Azure Kubernetes with Helm Charts and Cloudflare - Austin Barnes
  </title>
  <meta name="description" content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure." />
  <meta name="author" content="Austin Barnes" />
  <meta name="generator" content="Hugo 0.113.0"><link
    rel="stylesheet"
    href="https://www.cinderblook.com/css/styles.min.4c4284cce4f1e6121443c34e1affc66a4652d581177c59a97bd6ea162a1b07fa.css"
    integrity="sha256-TEKEzOTx5hIUQ8NOGv/GakZS1YEXfFmpe9bqFiobB/o="
  />
  
  

  <meta property="og:title" content="Terraform - Azure Kubernetes with Helm Charts and Cloudflare" />
<meta property="og:description" content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.cinderblook.com/blog/terraform-azure-k8s-helm/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-06-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-16T00:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Terraform - Azure Kubernetes with Helm Charts and Cloudflare"/>
<meta name="twitter:description" content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure."/>

  <meta itemprop="name" content="Terraform - Azure Kubernetes with Helm Charts and Cloudflare">
<meta itemprop="description" content="Terraform Automation in Azure with Kubernetes, Helm, and Cloudflare. Create a ready to go and modify AKS cluster in Azure."><meta itemprop="datePublished" content="2022-06-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-06-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="2383">
<meta itemprop="keywords" content="terraform,cloudflare,automation,azure,K8S," />
</head>
<body class="dark:bg-gray-800 dark:text-white relative flex flex-col min-h-screen"><header class="container flex justify-between md:justify-between gap-4 flex-wrap p-6 mx-auto relative">
  <a href="https://www.cinderblook.com/" class="capitalize font-extrabold text-2xl">
    
    Austin Barnes
    
  </a>
  <button class="mobile-menu-button md:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <line x1="4" y1="8" x2="20" y2="8" />
      <line x1="4" y1="16" x2="20" y2="16" />
    </svg>
  </button>
  <ul class="mobile-menu absolute z-10 px-6 pb-6 md:p-0 top-full left-0 w-full md:w-auto md:relative hidden md:flex flex-col md:flex-row items-end md:items-center gap-4 lg:gap-6 bg-white dark:bg-gray-800">

    
    <li><a href="/blog">Blog</a></li>
    
    <li><a href="/page/about/">About</a></li>
    
    <li><a href="/tags">Tags</a></li>
    
    <li><a href="https://github.com/Cinderblook">Github</a></li>
    
    <li><a href="/page/sites/">Sites</a></li>
    

    

    
    <li class="grid place-items-center">
      <span class="open-search inline-block cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="10" cy="10" r="7" />
          <line x1="21" y1="21" x2="15" y2="15" />
        </svg>
      </span>
    </li>
    

    
    <li class="grid place-items-center">
      <span class="toggle-dark-mode inline-block cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <circle cx="12" cy="12" r="3" />
          <line x1="12" y1="5" x2="12" y2="5.01" />
          <line x1="17" y1="7" x2="17" y2="7.01" />
          <line x1="19" y1="12" x2="19" y2="12.01" />
          <line x1="17" y1="17" x2="17" y2="17.01" />
          <line x1="12" y1="19" x2="12" y2="19.01" />
          <line x1="7" y1="17" x2="7" y2="17.01" />
          <line x1="5" y1="12" x2="5" y2="12.01" />
          <line x1="7" y1="7" x2="7" y2="7.01" />
        </svg>
      </span>
    </li>
    
  </ul>
</header>
<main class="flex-1">
  
  

  
  <div class="relative max-w-5xl mx-auto px-4">
    <img src="/covers/AzureK8SHelm.png" class="rounded-lg shadow-sm w-full object-contain" />
    <div class="absolute top-4 right-8 rounded shadow bg-white text-gray-900 dark:bg-gray-900 dark:text-white px-2 py-0.5">
      
  
    June 16, 2022
  


    </div>
  </div>
  

  <article class="prose lg:prose-lg mx-auto my-8 dark:prose-dark px-4">

    <h1 class="text-2xl font-bold mb-2">Terraform - Azure Kubernetes with Helm Charts and Cloudflare</h1>
    <h5 class="text-sm flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <rect x="4" y="5" width="16" height="16" rx="2" />
        <line x1="16" y1="3" x2="16" y2="7" />
        <line x1="8" y1="3" x2="8" y2="7" />
        <line x1="4" y1="11" x2="20" y2="11" />
        <rect x="8" y="15" width="2" height="2" />
      </svg>
      Posted on 
  
    June 16, 2022
  


      
        &nbsp;&bull;&nbsp;
      
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <circle cx="12" cy="12" r="9" />
        <polyline points="12 7 12 12 15 15" />
      </svg>
      12&nbsp;minutes
      &nbsp;&bull;
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <line x1="3" y1="6" x2="3" y2="19" />
        <line x1="12" y1="6" x2="12" y2="19" />
        <line x1="21" y1="6" x2="21" y2="19" />
      </svg>
      2383&nbsp;words
      
    </h5>

    <h1 id="overview">Overview</h1>
<p>Deplying helm charts in Kubernetes within Azure using the AKS service.</p>
<ul>
<li>Build a cluster that is running a few services</li>
<li>Have cluster automatically scale with load</li>
<li>Have Kubeconfig file available so it can be managed, changed, altered, destroyed, etc.</li>
<li>Ensure Kubeconfig file is secure, and is being encrypted with traffic involved in this</li>
<li>Create a NGINX certificate service utilizing Cloudflare&rsquo;s DNS</li>
<li>Use Traefik as a loadbalancer, and utilize ingresses for reachable internal services</li>
</ul>
<h3 id="prerequisites">Prerequisites</h3>
<ol>
<li>Have an Azure account
<ul>
<li><em><a href="https://azure.microsoft.com/en-us/free/students/">if you are a student, sign up for a student account and get some free credits along side it.</a></em></li>
</ul>
</li>
<li>Have a Cloudflare Account &amp; a Domain</li>
</ol>
<h2 id="outlined-in-this-post">Outlined in this post</h2>
<ol>
<li><a href="#creating-the-public--private-keys">Create a public and private key</a></li>
<li><a href="#setting-up-cloudflare">Setup Cloudflare</a>
<ul>
<li>Obtain a public domain</li>
<li>Generate a Token for DNS Read and write access</li>
</ul>
</li>
<li><a href="#terraform-process">Setup Terraform files for the deployment</a>
<ul>
<li><a href="#setting-up-providers-azurerm-kubernetes-helm">Providers</a></li>
<li><a href="#setting-up-infrastructure">Infrastructure</a></li>
<li><a href="#setting-up-the-kubernetes--helm-attributes">Kubernetes, Kubectl, &amp; Helm</a></li>
<li><a href="#assigning-variable-to-variablestfvars">Assigning Variables</a></li>
<li><a href="#creating-output-to-be-sent-back-after-terraform-finishes-running">Creating Output</a></li>
</ul>
</li>
<li><a href="#run-it">Run it</a></li>
<li><a href="#gain-access-to-kubectl">Terraform State and Kubeconfig file</a></li>
<li><a href="#now-what">Now What?</a></li>
<li><a href="#useful-resources">Useful Resources</a></li>
</ol>
<h2 id="creating-the-public--private-keys">Creating the Public &amp; Private keys</h2>
<p>First step we&rsquo;ll tackle is the creation of your public and private keys.</p>
<p>I find the easiest way to do this, is to open up a terminal (Powershell and/or pretty much any linux terminal) and type in a quick few commands. To keep it short and sweet, we will just use <code>ssh-keygen</code></p>
<p><img src="/examples/SSH-keygen-example1.png" alt="SSH-Keygen-Example" title="ssh-keygen-example1"></p>
<p>Ensure you save this to a locaiton you will remember, it&rsquo;ll be important not to loose either key. This&rsquo;ll allow you SSH access into your Kubernetes cluster.</p>
<p>Copy your public key you genereated into the same folder as your .tf files will be located.</p>
<h2 id="setting-up-cloudflare">Setting up Cloudflare</h2>
<p>Second step on our list, is to setup Cloudflare.</p>
<p>Cloudflare is important here, since it will be handing out certificates to services running within the Kubernetes cluster. Luckily, <a href="https://dash.cloudflare.com/login">signing up for Cloudflare is free</a>, and I&rsquo;ll go over how to obtain a Token for API access.</p>
<p>Once you have created your account, and have obtained a public domain, you should see a page similar to the following;</p>
<p><img src="/examples/Cloudflare-example1.png" alt="Cloudflare Overview Page" title="Cloudflare Overview Page"></p>
<p>Scroll down on the overview tab, and on the right hand side, there should be a &lsquo;Get your API token&rsquo; link. On the following page, click &lsquo;Create token&rsquo;</p>
<p><img src="/examples/Cloudflare-example2.png" alt="Cloudflare Token Creation" title="Cloudflare Token Creation"></p>
<p>Scroll down to the bottom, and select &lsquo;Create Custom Token`. On the following page, ensure you give your token a memorable name, assign it permissions to read and edit DNS zone settings, and limit it to your respective Zone resources (Domain). Set the TTL to the duration of your project.</p>
<p><img src="/examples/Cloudflare-example3.png" alt="Cloudflare Token Policy" title="Cloudflare Token Policy"></p>
<p>Continue to summary, and collect the API token key, store it discretely. This Token will be used in Terraform, within the .tfvars file later for authentication with the Cloudflare API.</p>
<h2 id="terraform-process">Terraform Process</h2>
<p>I prefer to seperate my Terraform files for readability, feel free to see all the code at a glance on the <a href="">Github Repo</a>. I&rsquo;ll do a breakdown here in this section.</p>
<h3 id="setting-up-providers-azurerm-kubernetes-helm-kubectl">Setting up Providers; Azurerm, Kubernetes, Helm, Kubectl</h3>
<p>In this situation, I am authenticating to Azure using their AzureCLI. Refer to <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Microsoft&rsquo;s official documentation for Azure CLI</a> setup. Kubernetes, Kubectl, and Helm don&rsquo;t require and specific authentication. The API Token generated earlier to authenticate with Cloudflare. This&rsquo;ll be defined in the .tfvars file.</p>
<p>Take the following code, and put it into a file called providers.tf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span>terraform {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">required_version</span> = <span style="color:#f1fa8c">&#34;&gt;= 0.14.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  required_providers {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">azurerm</span> = {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">source</span>  = <span style="color:#f1fa8c">&#34;hashicorp/azurerm&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">version</span> = <span style="color:#f1fa8c">&#34;~&gt; 3.0.2&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">helm</span> = {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">source</span> = <span style="color:#f1fa8c">&#34;hashicorp/helm&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">version</span> = <span style="color:#f1fa8c">&#34;~&gt;2.5.1&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">kubernetes</span> = {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">source</span> = <span style="color:#f1fa8c">&#34;hashicorp/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">version</span> = <span style="color:#f1fa8c">&#34;~&gt; 2.8.0&#34;</span>     
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">kubectl</span> = {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">source</span> = <span style="color:#f1fa8c">&#34;gavinbunney/kubectl&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">version</span> = <span style="color:#f1fa8c">&#34;~&gt; 1.14.0&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">cloudflare</span> = {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">source</span> = <span style="color:#f1fa8c">&#34;cloudflare/cloudflare&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">version</span> = <span style="color:#f1fa8c">&#34;~&gt; 3.16.0&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;azurerm&#34;</span> {
</span></span><span style="display:flex;"><span>  features {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;kubernetes&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">host</span>        = <span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.host
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">client_certificate</span>     =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.client_certificate)
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">client_key</span>             =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.client_key)
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">cluster_ca_certificate</span> =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.cluster_ca_certificate)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;helm&#34;</span> {
</span></span><span style="display:flex;"><span>  kubernetes {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">host</span>        = <span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.host
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">client_certificate</span>     =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.client_certificate)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">client_key</span>             =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.client_key)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">cluster_ca_certificate</span> =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.cluster_ca_certificate)    
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;kubectl&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">host</span>        = <span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.host
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">client_certificate</span>     =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.client_certificate)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">client_key</span>             =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.client_key)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">cluster_ca_certificate</span> =<span style="color:#8be9fd;font-style:italic"> base64decode</span>(<span style="color:#8be9fd;font-style:italic">data</span>.azurerm_kubernetes_cluster.credneitals.kube_config.<span style="color:#bd93f9">0</span>.cluster_ca_certificate)  
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">load_config_file</span> = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">provider</span> <span style="color:#f1fa8c">&#34;cloudflare&#34;</span> {<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  # Comment out key &amp; email if using token
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #email = var.cloudflare_email
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #api_key = var.cloudflare_api_key
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">api_token</span> = <span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_token
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="setting-up-infrastructure">Setting up infrastructure</h3>
<p>I sepereated the &lsquo;structure&rsquo; into a few seperate files. One for networking aspects in Azure; <code>networking.tf</code>. Another for the k8s cluster itself (AKS); <code>cluster.tf</code>.</p>
<p>Within the networking file, it will setup firewall rules for the virtual private network, create the network itself, and create a load balancer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#6272a4"># Resource Group for Terraform deployment
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_resource_group&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>     = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">location</span> = <span style="color:#8be9fd;font-style:italic">var</span>.region
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Networking Setup for Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_virtual_network&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>                = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-network&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">location</span>            = azurerm_resource_group.cluster.location
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">resource_group_name</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">address_space</span>       = [<span style="color:#f1fa8c">&#34;10.1.0.0/16&#34;</span>]
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Assign subnet for Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_subnet&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>                 = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-subnet&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">virtual_network_name</span> = azurerm_virtual_network.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">resource_group_name</span>  = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">address_prefixes</span>     = [<span style="color:#f1fa8c">&#34;10.1.0.0/24&#34;</span>]
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Firewall settings for cluster
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_network_security_group&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>                = <span style="color:#f1fa8c">&#34;Allow-RDP-SSH-KCTL&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">location</span>            = azurerm_resource_group.cluster.location
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">resource_group_name</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>  security_rule {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span>                       = <span style="color:#f1fa8c">&#34;HTTP&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">priority</span>                   = <span style="color:#bd93f9">101</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">direction</span>                  = <span style="color:#f1fa8c">&#34;Inbound&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">access</span>                     = <span style="color:#f1fa8c">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">protocol</span>                   = <span style="color:#f1fa8c">&#34;Tcp&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">source_port_range</span>          = <span style="color:#f1fa8c">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">destination_port_range</span>     = <span style="color:#f1fa8c">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">source_address_prefix</span>      = <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">destination_address_prefix</span> = <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  security_rule {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span>                       = <span style="color:#f1fa8c">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">priority</span>                   = <span style="color:#bd93f9">102</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">direction</span>                  = <span style="color:#f1fa8c">&#34;Inbound&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">access</span>                     = <span style="color:#f1fa8c">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">protocol</span>                   = <span style="color:#f1fa8c">&#34;Tcp&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">source_port_range</span>          = <span style="color:#f1fa8c">&#34;443&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">destination_port_range</span>     = <span style="color:#f1fa8c">&#34;443&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">source_address_prefix</span>      = <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">destination_address_prefix</span> = <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>   security_rule {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span>                       = <span style="color:#f1fa8c">&#34;k8s-api&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">priority</span>                   = <span style="color:#bd93f9">103</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">direction</span>                  = <span style="color:#f1fa8c">&#34;Inbound&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">access</span>                     = <span style="color:#f1fa8c">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">protocol</span>                   = <span style="color:#f1fa8c">&#34;Tcp&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">source_port_range</span>          = <span style="color:#f1fa8c">&#34;6443&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">destination_port_range</span>     = <span style="color:#f1fa8c">&#34;6443&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">source_address_prefix</span>      = <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">destination_address_prefix</span> = <span style="color:#f1fa8c">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Force Terraform to wait
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;time_sleep&#34;</span> <span style="color:#f1fa8c">&#34;wait_for_kubernetes&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [azurerm_kubernetes_cluster.cluster]
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">create_duration</span> = <span style="color:#f1fa8c">&#34;20s&#34;</span>
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Create public IP for load balancer
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_public_ip&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>                = <span style="color:#f1fa8c">&#34;K8S-PublicIPAddress&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">resource_group_name</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">location</span>            = azurerm_resource_group.cluster.location
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">allocation_method</span>   = <span style="color:#f1fa8c">&#34;Static&#34;</span>
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Assign loadbalancer to a Data variable, for user later
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_lb&#34;</span> <span style="color:#f1fa8c">&#34;traefik_lb&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [helm_release.traefik]
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;k8s-traefik-lb&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">resource_group_name</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">location</span>            = azurerm_resource_group.cluster.location
</span></span><span style="display:flex;"><span>    frontend_ip_configuration {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">name</span>                 = azurerm_public_ip.cluster.name
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">public_ip_address_id</span> = azurerm_public_ip.cluster.id
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Within the cluster file, we&rsquo;ll define the virtual machine AKS structure being created.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#6272a4"># Create Kubernetes Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;azurerm_kubernetes_cluster&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>                = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-aks&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">location</span>            = azurerm_resource_group.cluster.location
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">resource_group_name</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">dns_prefix</span>          = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">-aks&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    linux_profile {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">admin_username</span> = <span style="color:#8be9fd;font-style:italic">var</span>.linux_user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ssh_key {
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">key_data</span> = <span style="color:#8be9fd;font-style:italic">file</span>(<span style="color:#8be9fd;font-style:italic">var</span>.ssh_public_key)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  default_node_pool {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span>                = <span style="color:#f1fa8c">&#34;agentpool&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">node_count</span>          = <span style="color:#8be9fd;font-style:italic">var</span>.cluster_nodes_count
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">vm_size</span>             = <span style="color:#f1fa8c">&#34;Standard_B2s&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">type</span>                = <span style="color:#f1fa8c">&#34;VirtualMachineScaleSets&#34;</span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #availability_zones  = [&#34;1&#34;, &#34;2&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">enable_auto_scaling</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">min_count</span>           = <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">max_count</span>           = <span style="color:#bd93f9">3</span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    # Required for advanced networking
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">vnet_subnet_id</span> = azurerm_subnet.cluster.id
</span></span><span style="display:flex;"><span>  }<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    ### Uncomment this and add id/secret for management 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #service_principal {
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #    client_id     = var.aks_service_principal_app_id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #    client_secret = var.aks_service_principal_client_secret
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    #}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  identity {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">type</span> = <span style="color:#f1fa8c">&#34;SystemAssigned&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  network_profile {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">network_plugin</span>    = <span style="color:#f1fa8c">&#34;kubenet&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">load_balancer_sku</span> = <span style="color:#f1fa8c">&#34;standard&#34;</span>
</span></span><span style="display:flex;"><span>  }<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  #addon_profile {
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  #    oms_agent {
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  #    enabled                    = true
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  #    log_analytics_workspace_id = azurerm_log_analytics_workspace.test.id
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  #    }
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">  #}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">tags</span> = {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">Environment</span> = <span style="color:#f1fa8c">&#34;Development&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Assign credentials to data, used for helm, kubernetes, and kubectl providers.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">data</span> <span style="color:#f1fa8c">&#34;azurerm_kubernetes_cluster&#34;</span> <span style="color:#f1fa8c">&#34;credneitals&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span>                = azurerm_kubernetes_cluster.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">resource_group_name</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">depends_on</span>          = [azurerm_kubernetes_cluster.cluster]
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Pull kubeconfig to your local machine
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;local_file&#34;</span> <span style="color:#f1fa8c">&#34;kubeconfig&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">depends_on</span>   = [azurerm_kubernetes_cluster.cluster]
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">filename</span>     = <span style="color:#f1fa8c">&#34;./kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">content</span>      = azurerm_kubernetes_cluster.cluster.kube_config_raw
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="setting-up-the-kubernetes--helm-attributes">Setting up the Kubernetes &amp; Helm attributes</h3>
<p>First file we&rsquo;ll make is a <code>nginx.tf</code> file. Within it we will define the manifest attributes of the deployment, and setup an ingress for accessing the service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#6272a4"># nginx deployment
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_namespace&#34;</span> <span style="color:#f1fa8c">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        azurerm_kubernetes_cluster.cluster
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Create the YAML configuration for nginx within the kubernetes provider
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_deployment&#34;</span> <span style="color:#f1fa8c">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        kubernetes_namespace.nginx
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">namespace</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">labels</span> = {
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">app</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    spec {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">replicas</span> = <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        selector {
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">match_labels</span> = {
</span></span><span style="display:flex;"><span>                <span style="color:#50fa7b">app</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        template {
</span></span><span style="display:flex;"><span>            metadata {
</span></span><span style="display:flex;"><span>                <span style="color:#50fa7b">labels</span> = {
</span></span><span style="display:flex;"><span>                    <span style="color:#50fa7b">app</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            spec {
</span></span><span style="display:flex;"><span>                container {
</span></span><span style="display:flex;"><span>                    <span style="color:#50fa7b">image</span> = <span style="color:#f1fa8c">&#34;nginx:latest&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#50fa7b">name</span>  = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    port {
</span></span><span style="display:flex;"><span>                        <span style="color:#50fa7b">container_port</span> = <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Set namespace and port assignments for nginx access
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_service&#34;</span> <span style="color:#f1fa8c">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [kubernetes_namespace.nginx]
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">namespace</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    spec {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">selector</span> = {
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">app</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        port {
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">port</span> = <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">type</span> = <span style="color:#f1fa8c">&#34;ClusterIP&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Create ingress for NGINX - Allow outside communication to it 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_ingress_v1&#34;</span> <span style="color:#f1fa8c">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [kubernetes_namespace.nginx]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">namespace</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    spec {
</span></span><span style="display:flex;"><span>        rule {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#50fa7b">host</span> = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_domainname<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            http {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                path {
</span></span><span style="display:flex;"><span>                    <span style="color:#50fa7b">path</span> = <span style="color:#f1fa8c">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    backend {
</span></span><span style="display:flex;"><span>                        service {
</span></span><span style="display:flex;"><span>                            <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>                            port {
</span></span><span style="display:flex;"><span>                                <span style="color:#50fa7b">number</span> = <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tls {
</span></span><span style="display:flex;"><span>          <span style="color:#50fa7b">secret_name</span> = <span style="color:#f1fa8c">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#50fa7b">hosts</span> = [<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_domainname<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Assign deployments/nginx-cert.yml file to a data value 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">data</span> <span style="color:#f1fa8c">&#34;kubectl_path_documents&#34;</span> <span style="color:#f1fa8c">&#34;nginx&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">pattern</span> = <span style="color:#f1fa8c">&#34;./deployments/nginx-cert.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">vars</span> = {
</span></span><span style="display:flex;"><span>        cloudflare<span style="color:#ff79c6">-</span><span style="color:#50fa7b">domainname</span> = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_domainname<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Set nginx config, pulls yaml information from deployments/nginx-cert.yml 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubectl_manifest&#34;</span> <span style="color:#f1fa8c">&#34;nginx-certificate&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">for_each</span>     = <span style="color:#8be9fd;font-style:italic">toset</span>(<span style="color:#8be9fd;font-style:italic">data</span>.kubectl_path_documents.nginx.documents)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">yaml_body</span>    = <span style="color:#8be9fd;font-style:italic">each</span>.value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [kubernetes_namespace.nginx, time_sleep.wait_for_clusterissuer]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The second step setup, is to define <code>cloudflare.tf</code> file for setting up Cloudflare and the certmanager aspect. This will be done by using Kubectl manifest, namespace creation, and a Helm chart deployment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#6272a4"># Assign namespace for certmanager
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_namespace&#34;</span> <span style="color:#f1fa8c">&#34;certmanager&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        azurerm_kubernetes_cluster.cluster
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;certmanager&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Intiates Cloudflare secret for Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_secret&#34;</span> <span style="color:#f1fa8c">&#34;cloudflare_api_key_secret&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        kubernetes_namespace.certmanager
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;cloudflare-api-key-secret&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">namespace</span> = <span style="color:#f1fa8c">&#34;certmanager&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">    data</span> <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        api<span style="color:#ff79c6">-</span><span style="color:#50fa7b">key</span> = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_api_key<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">type</span> = <span style="color:#f1fa8c">&#34;Opaque&#34;</span>
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Assign deployments/cloudflare.yml file to a data value 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">data</span> <span style="color:#f1fa8c">&#34;kubectl_path_documents&#34;</span> <span style="color:#f1fa8c">&#34;cloudflare&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">pattern</span> = <span style="color:#f1fa8c">&#34;./deployments/cloudflare.yml&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">vars</span> = {
</span></span><span style="display:flex;"><span>        cloudflare<span style="color:#ff79c6">-</span><span style="color:#50fa7b">email</span> = <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_email<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Create a ClusterIssuer, pulls yaml information from deployments/cloudflare.yml
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubectl_manifest&#34;</span> <span style="color:#f1fa8c">&#34;cloudflare_prod&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">for_each</span>     = <span style="color:#8be9fd;font-style:italic">toset</span>(<span style="color:#8be9fd;font-style:italic">data</span>.kubectl_path_documents.cloudflare.documents)       
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">yaml_body</span>    = <span style="color:#8be9fd;font-style:italic">each</span>.value
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [time_sleep.wait_for_certmanager]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;cloudflare_record&#34;</span> <span style="color:#f1fa8c">&#34;cluster&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">zone_id</span> = <span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_zonid
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span> = <span style="color:#8be9fd;font-style:italic">var</span>.cloudflare_domainname
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">value</span> =  azurerm_public_ip.cluster.ip_address
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">type</span> = <span style="color:#f1fa8c">&#34;A&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">proxied</span> = <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [azurerm_lb.traefik_lb]
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Force Terraform to wait
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;time_sleep&#34;</span> <span style="color:#f1fa8c">&#34;wait_for_clusterissuer&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        kubectl_manifest.cloudflare_prod
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">create_duration</span> = <span style="color:#f1fa8c">&#34;30s&#34;</span>
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Use helm to deploy certmanager in cluster
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;helm_release&#34;</span> <span style="color:#f1fa8c">&#34;certmanager&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        kubernetes_namespace.certmanager
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;certmanager&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">namespace</span> = <span style="color:#f1fa8c">&#34;certmanager&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">repository</span> = <span style="color:#f1fa8c">&#34;https://charts.jetstack.io&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">chart</span> = <span style="color:#f1fa8c">&#34;cert-manager&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    set {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">name</span>  = <span style="color:#f1fa8c">&#34;installCRDs&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">value</span> = <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Force Terraform to wait
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;time_sleep&#34;</span> <span style="color:#f1fa8c">&#34;wait_for_certmanager&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>        helm_release.certmanager
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">create_duration</span> = <span style="color:#f1fa8c">&#34;10s&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Third we will create the <code>traefik.tf</code> file. This will allow use to utilize loadbalacning and ingress.Traefik will be implemented using Helm.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#6272a4"># Traefik Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;kubernetes_namespace&#34;</span> <span style="color:#f1fa8c">&#34;traefik&#34;</span> {
</span></span><span style="display:flex;"><span>    metadata {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;traefik&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">resource</span> <span style="color:#f1fa8c">&#34;helm_release&#34;</span> <span style="color:#f1fa8c">&#34;traefik&#34;</span> {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">depends_on</span> = [
</span></span><span style="display:flex;"><span>    kubernetes_namespace.traefik
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;traefik&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">namespace</span> = <span style="color:#f1fa8c">&#34;traefik&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">repository</span> = <span style="color:#f1fa8c">&#34;https://helm.traefik.io/traefik&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">chart</span>      = <span style="color:#f1fa8c">&#34;traefik&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  set {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span>  = <span style="color:#f1fa8c">&#34;ingressClass.enabled&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">value</span> = <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  set {
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">name</span>  = <span style="color:#f1fa8c">&#34;ingressClass.isDefaultClass&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">value</span> = <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  set {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;ports.web.redirectTo&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">value</span> = <span style="color:#f1fa8c">&#34;websecure&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  set {
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">name</span> = <span style="color:#f1fa8c">&#34;ports.websecure.tls.enabled&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">value</span> = <span style="color:#f1fa8c">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">data</span> <span style="color:#f1fa8c">&#34;kubernetes_service&#34;</span> <span style="color:#f1fa8c">&#34;traefik&#34;</span> {
</span></span><span style="display:flex;"><span> metadata {
</span></span><span style="display:flex;"><span>   <span style="color:#50fa7b">name</span> = helm_release.traefik.name
</span></span><span style="display:flex;"><span>   <span style="color:#50fa7b">namespace</span> = helm_release.traefik.namespace
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="assigning-variable-to-variablestfvars">Assigning variable to variables.tfvars</h3>
<p>First create and define variables within a <code>variables.tf</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cluster_name&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">default</span> = <span style="color:#f1fa8c">&#34;terraformclust&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cluster_nodes_count&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">default</span> = <span style="color:#f1fa8c">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;region&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">default</span> = <span style="color:#f1fa8c">&#34;East US 2&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;prefix&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">default</span> = <span style="color:#f1fa8c">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;ssh_public_key&#34;</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">default</span> = <span style="color:#f1fa8c">&#34;./id_rsa.pub&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_api_key&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_email&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_api_key_secret&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_prod_account_key&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_zonid&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_domainname&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;cloudflare_token&#34;</span> {}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">variable</span> <span style="color:#f1fa8c">&#34;linux_user&#34;</span> {}
</span></span></code></pre></div><p>Assign correct Cloudflare information into the <code>tfvariables.auto.tfvars</code> file. Follow along with the <code>tfvariables.auto.tfvars.example</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#50fa7b">cloudflare_api_key</span> = <span style="color:#f1fa8c">&#34;api key here&#34;</span><span style="color:#6272a4">                                 # This should have DNS read/write permissions in Cloudflare 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cloudflare_email</span>   = <span style="color:#f1fa8c">&#34;email associated to account&#34;</span><span style="color:#6272a4">                  # Used to login with
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cloudflare_api_key_secret</span> = <span style="color:#f1fa8c">&#34;Cloudflare key secret&#34;</span><span style="color:#6272a4">                 # Used for cloudflare.yml file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cloudflare_prod_account_key</span> = <span style="color:#f1fa8c">&#34;Cloudflare production account key&#34;</span><span style="color:#6272a4">   # Used for cloudflare.yml file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cloudflare_zonid</span> = <span style="color:#f1fa8c">&#34;Zone ID for cloudflare account&#34;</span><span style="color:#6272a4">                 # Used for Cloudflare resource
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cloudflare_domainname</span> = <span style="color:#f1fa8c">&#34;domain name&#34;</span><span style="color:#6272a4">                               # Used for Cloudflare resource
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">cloudflare_token</span> = <span style="color:#f1fa8c">&#34;cloudflare token&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">linux_user</span> = <span style="color:#f1fa8c">&#34;username&#34;</span><span style="color:#6272a4">                                             #Admin access to cluster master(s)
</span></span></span></code></pre></div><p>As for the SSH key, ensure you have a .pub file that you are pulling data from, or directly put SSH key into into variable file.</p>
<h2 id="creating-output-to-be-sent-back-after-terraform-finishes-running">Creating output to be sent back after Terraform finishes running</h2>
<p>An important step, is creating necessary output data to result from running the terraform apply. In this scenario, it is critical to have data from the cluster such as certificate information, the kubeconfig, and cluster credentials. Luckily, since these are obviously sensitive data, we can force a <code>sensitive = true</code> attribute to them, and just have the State file hold onto that information. This&rsquo;ll allow us to pull the Kube config to control the K8S cluster to our machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tf" data-lang="tf"><span style="display:flex;"><span><span style="color:#6272a4"># It is necessary to identify these variables for usage later when updating the state file or using kubectl commands
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;client_key&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config.<span style="color:#bd93f9">0</span>.client_key
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;client_certificate&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config.<span style="color:#bd93f9">0</span>.client_certificate
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;cluster_ca_certificate&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config.<span style="color:#bd93f9">0</span>.cluster_ca_certificate
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;cluster_username&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config.<span style="color:#bd93f9">0</span>.username
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;cluster_password&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config.<span style="color:#bd93f9">0</span>.password
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;kube_config&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config_raw
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;host&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.kube_config.<span style="color:#bd93f9">0</span>.host
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">sensitive</span> = <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"># Critical to get kubectl file connected out to Azure for local environment
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;cluster_name&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_kubernetes_cluster.cluster.name
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;resource_group_name&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_resource_group.cluster.name
</span></span><span style="display:flex;"><span>}<span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">#Public IP of Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">output</span> <span style="color:#f1fa8c">&#34;cluster_public_ip&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">value</span> = azurerm_public_ip.cluster.ip_address
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="run-it">Run it</h2>
<p>Once everything is setup and ready to roll, navigate into the directory containing all terraform files.</p>
<ol>
<li>Run a <code>terraform init</code></li>
<li>Then <code>terraform validate</code></li>
<li>If everything checks out, run <code>terraform apply</code>, and in roughly 5 minutes you should have a running AKS cluster in Azure!</li>
</ol>
<h2 id="gain-access-to-kubectl">Gain access to Kubectl</h2>
<p>In order to gain access from your local machine, we will use the azure CLI. If you followed the tutorial, you&rsquo;ll already be logged in, <code>az login</code>. Use the following command to set your environment varialbe for kubectl to control kubernetes cluster in Azure.
<code>az aks get-credentials --resource-group $(terraform output -raw resource_group_name) --name $(terraform output -raw cluster_name)</code></p>
<p>Once ran, you can verify it is connected and working with <code>kubectl get nodes</code> , <code>kubectl get namespace</code></p>
<h2 id="now-what">Now what?</h2>
<p>Congragulations! The hard part of getting started, is now over. You now have a ready to spin up AKS cluster in Azure prebuilt with a loadbalancer and certificate automation. From here, the possibilites are limitless.</p>
<h2 id="useful-resources">Useful Resources</h2>
<ul>
<li><a href="https://learnk8s.io/terraform-aks">Kubernetes Overview</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest">Terraform Kubernetes</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest">Terraform Azurerm</a></li>
<li><a href="https://registry.terraform.io/providers/hashicorp/helm/2.5.0">Terraform Helm</a></li>
</ul>
<p><a href="https://github.com/xcad2k/boilerplates/tree/main/terraform/templates/kubernetes-automation-example">https://github.com/xcad2k/boilerplates/tree/main/terraform/templates/kubernetes-automation-example</a>
<a href="https://www.youtube.com/watch?v=kFt0OGd_LhI&amp;t=870s">https://www.youtube.com/watch?v=kFt0OGd_LhI&amp;t=870s</a></p>

  </article><div class="bg-blue-100 dark:bg-gray-900">
  <div class="container px-6 py-12 mx-auto max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
    <div>
      <div class="text-2xl font-bold mb-2">Follow me</div>
      <p class="opacity-60">I put a little bit of everything on here, so follow along in my journey if you wish</p>
    </div>
    <ul class="flex justify-center gap-4">
      
      
      <li>
        <a
          href="https://www.linkedin.com/in/austin-barnes-03869218a/"
          target="_blank"
          rel="noopener"
          aria-label="LinkedIn"
          class="p-2 inline-block rounded-full border border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-800 cursor-pointer transition-colors dark:text-gray-600 dark:hover:border-gray-300 dark:hover:text-gray-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <rect x="4" y="4" width="16" height="16" rx="2" />
            <line x1="8" y1="11" x2="8" y2="16" />
            <line x1="8" y1="8" x2="8" y2="8.01" />
            <line x1="12" y1="16" x2="12" y2="11" />
            <path d="M16 16v-3a2 2 0 0 0 -4 0" />
          </svg>
        </a>
      </li>
      
      
      
      <li>
        <a
          href="https://github.com/Cinderblook"
          target="_blank"
          rel="noopener"
          aria-label="GitHub"
          class="p-2 inline-block rounded-full border border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-800 cursor-pointer transition-colors dark:text-gray-600 dark:hover:border-gray-300 dark:hover:text-gray-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"
            />
          </svg>
        </a>
      </li>
      
      
      
      <li>
        <a
          href="https://www.buymeacoffee.com/cinderblook"
          target="_blank"
          rel="noopener"
          aria-label="coffeescript"
          class="p-2 inline-block rounded-full border border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-800 cursor-pointer transition-colors dark:text-gray-600 dark:hover:border-gray-300 dark:hover:text-gray-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4.645 7.472c2.1.53 4.779.8 8.008.8 3.299 0 5.918-.27 8.008-.8 2.23-.52 3.299-1.22 3.299-1.88 0-.47-.48-.93-1.35-1.28.2.13.35.35.35.59 0 .67-1.01 1.22-3.039 1.68-1.88.41-4.279.7-7.198.7-2.82 0-5.329-.29-7.138-.68-1.95-.48-2.97-1-2.97-1.68 0-.28.13-.52.52-.8-1.22.47-1.88.87-1.88 1.47.07.68 1.16 1.36 3.39 1.88zm4.689-2.16c2.27-.2 2.929-1.659 5.588-1.899 1.31-.1 2.14.16 2.23.62.08.43-.57.72-1.36.78-1.09.11-1.54-.28-1.63-.65-.81.09-.94.43-.9.67.09.46 1.07.92 2.75.76 1.9-.15 2.54-.9 2.38-1.65-.2-.98-1.66-1.8-4.28-1.55-3.359.3-3.339 1.86-5.628 2.05-.94.09-1.46-.13-1.55-.5-.06-.37.4-.55.94-.59.5-.05 1.11.04 1.4.2.21-.11.28-.22.26-.35-.1-.35-.79-.5-1.66-.44-1.7.15-1.7.91-1.64 1.25.17.87 1.48 1.45 3.1 1.3zm11.417 3.84c-2.1.49-4.779.809-8.008.809-3.3 0-5.989-.34-8.078-.8-1.88-.48-2.88-1.01-3.23-1.56.18 1.23.49 2.42.89 3.55-.48.3-.91.67-1.3 1.17a4.519 4.519 0 00-1.019 3.098 3.6 3.599 0 001.42 2.62c.87.68 1.81.88 2.879.68.41-.07.87-.28 1.29-.42-.88 0-1.62-.28-2.36-.87a3.55 3.549 0 01-1.49-2.42c-.2-.94 0-1.81.53-2.579.12-.15.25-.28.39-.4.3.73.62 1.45.98 2.12.81 1.23 1.62 2.299 2.43 3.459.35.68.58 1.35.74 2.019a3.899 3.899 0 002.229 1.5c1.15.4 2.35.58 3.579.51h.13a10.197 10.197 0 003.689-.52 4.179 4.179 0 002.16-1.49h.07c.13-.67.35-1.34.67-2.02.799-1.17 1.619-2.229 2.419-3.458A20.995 20.993 0 0024 7.612c-.43.6-1.44 1.13-3.25 1.54z"/></svg>
            <rect x="4" y="4" width="16" height="16" rx="2" />
            <path d="M8 9h1l3 3l3 -3h1" />
            <line x1="8" y1="15" x2="10" y2="15" />
            <line x1="14" y1="15" x2="16" y2="15" />
            <line x1="9" y1="9" x2="9" y2="15" />
            <line x1="15" y1="9" x2="15" y2="15" />
          </svg>
        </a>
      </li>
      
      
      
      
      
      <li>
        <a
          href="https://www.instagram.com/austin_barnesz/"
          target="_blank"
          rel="noopener"
          aria-label="Instagram"
          class="p-2 inline-block rounded-full border border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-800 cursor-pointer transition-colors dark:text-gray-600 dark:hover:border-gray-300 dark:hover:text-gray-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="icon icon-tabler icon-tabler-brand-instagram"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" />
            <circle cx="12" cy="12" r="9" />
            <path d="M10 9l5 3l-5 3z" />
          </svg>
        </a>
      </li>
      
    </ul>
  </div>
</div>
    </main><footer class="container p-6 mx-auto flex justify-between items-center">
  <span class="text-sm font-light">
    
    Copyright © 2021 - Austin Barnes · All rights reserved
    
  </span>
  <span onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-1 cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M18 15l-6 -6l-6 6h12" />
    </svg>
  </span>
</footer>

<div class="search-ui absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 hidden">
  <div class="container max-w-3xl mx-auto p-12">
    <div class="relative">
      <div class="my-4 text-center text-2xl font-bold">Search</div>

      <span class="p-2 absolute right-0 top-0 cursor-pointer close-search">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </span>
    </div>

    <input type="search" class="py-2 px-3 w-full dark:text-black border dark:border-transparent"
      placeholder="Enter search query" />

    <div class="search-results text-lg font-medium my-4 hidden">Results</div>
    <ul class="search-list my-2">

    </ul>

    <div class="no-results text-center my-8 hidden">
      <div class="text-xl font-semibold mb-2">No results found</div>
      <p class="font-light text-sm">Try adjusting your search query</p>
    </div>
  </div>
</div>





<script src="https://www.cinderblook.com/js/scripts.min.js"></script>






<script>
  
  const darkmode = document.querySelector('.toggle-dark-mode');
  function toggleDarkMode() {
    if (document.documentElement.classList.contains('dark')) {
      document.documentElement.classList.remove('dark')
      localStorage.setItem('darkmode', 'light')
    } else {
      document.documentElement.classList.add('dark')
      localStorage.setItem('darkmode', 'dark')
    }
  }
  if (darkmode) {
    darkmode.addEventListener('click', toggleDarkMode);
  }

  const darkStorage = localStorage.getItem('darkmode');
  const isBrowserDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

  if (!darkStorage && isBrowserDark) {
    document.documentElement.classList.add('dark');
  }

  if (darkStorage && darkStorage === 'dark') {
    toggleDarkMode();
  }
</script>


<script>
  const mobileMenuButton = document.querySelector('.mobile-menu-button')
  const mobileMenu = document.querySelector('.mobile-menu')
  function toggleMenu() {
    mobileMenu.classList.toggle('hidden');
    mobileMenu.classList.toggle('flex');
  }
  if(mobileMenu && mobileMenuButton){
    mobileMenuButton.addEventListener('click', toggleMenu)
  }
</script>
</body>
</html>
